# Automated Trade Control
# Hangar System

use aliases
use constants

# Input Devices
alias Self db
alias Memory d0
alias Dial d1
alias Lever d2
alias Display d3

# Constants
const StateIdle = 0
const StatePressurizing = 1
const StateDepressurizing = 2

const SensorHash = -1252983604
const ActiveVentHash = -1129453144
const HangarDoorHash = -1351081801
const FlashingLightHash = -1535893860
const SpeakerHash = -1

const Inward = 1
const Outward = 0

const TargetPressureFilled = 0.5
const TargetPressureEmtpy = 0.5

# Variables
var State
var HangarMode
var ManualCommand

function WaitDoors()
    var HangarDoorState = d(HangarDoorHash).Idle(Sum)
    Display.Setting = HangarDoorState
    yield

    if HangarDoorState > 0    
        Display.Setting = 666
        yield
        WaitDoors()
    end
end

function StandBy()
    if ManualCommand == 1
        if HangarMode == 0
            j Main
        end

        State = HangarMode    
    end

    Execute()
end

function ToggleDoors(Status)
    Display.Setting = Status
    d(HangarDoorHash).Open = Status
    WaitDoors()
end

function Pressurize()
    Self.Setting = StatePressurizing
    Display.Setting = 222
    ToggleDoors(1)
    
    # Active vent e checagem de pressao aqui
    Finalize()
end

function Depressurize()
    Display.Setting = 555
    Self.Setting = StateDepressurizing
    ToggleDoors(0)
    
    # Active vent e checagem de pressao aqui
    Finalize()
end

function Finalize()
    Self.Setting = StateIdle
    Display.Setting = 1010
    yield
end

function Execute()
    switch State
        case StateIdle
            Display.Setting = 222
            yield
            StandBy()
        end
        case StatePressurizing
            Display.Setting = 333
            yield
            Pressurize()
        end
        case StateDepressurizing
            Display.Setting = 444
            yield
            Depressurize()
        end
    end
end

# Functions
Main:
    # Self.Setting = 0
    State = Self.Setting
    Display.Setting = 111

    ManualCommand = Lever.Setting
    HangarMode = Dial.Setting
    
    yield
    
    Execute()

j Main